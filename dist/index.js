module.exports=function(t){var e={};function i(n){if(e[n])return e[n].exports;var s=e[n]={i:n,l:!1,exports:{}};return t[n].call(s.exports,s,s.exports,i),s.l=!0,s.exports}return i.m=t,i.c=e,i.d=function(t,e,n){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var s in t)i.d(n,s,function(e){return t[e]}.bind(null,s));return n},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=2)}([function(t,e){t.exports=require("util")},function(t,e){t.exports=require("events")},function(t,e,i){var n=i(0),s=i(3),r=i(1).EventEmitter,o=i(4);function c(t){r.call(this),this.client=s.createClient(t),this.init()}c.prototype={init:function(){var t=this;["connect","ready","error","close","reconnecting","end","message","messageBuffer"].forEach(e=>{this.client.on(e,function(){for(var i=arguments.length,n=new Array(i),s=0;s<i;s++)n[s]=arguments[s];t.emit(e,...n)})})},subscribe:function(){this.client.subscribe(...arguments)},publish:function(){this.client.publish(...arguments)},queue:function(t){return new o(this.client,t)},process:function(t,e){n.isArray(t)||(t=[t]);for(let n=0;n<t.length;n++){var i=t[n];this.queue(Object.assign({name:i,auto:!0},e||{})).on("process",t=>{this.emit("process",i,t)})}},end:function(){this.client.end()}},n.inherits(c,r),t.exports.create=function(t){return new c(t)}},function(t,e){t.exports=require("redis")},function(t,e,i){var n=i(0),s=i(5),r=i(1).EventEmitter,o=i(6);function c(t,e){r.call(this),this.options=Object.assign({prefix:"KongMQ",auto:!1,ttl:0,limit:0,retry:3,debug:!0,timeout:0},e),this.id=[this.options.prefix,e.name].join(":"),this.client=t,this.idle=!1,this.acknowledged=!0,this.timer=null,this.init()}c.prototype={_key:function(t){return[this.options.prefix,this.options.name,t].join(":")},_expired:function(t){var e=t.ttl||this.options.ttl,i=Date.now();return!!e&&t.created+e-i<=0},log:function(t){this.options.debug&&console.debug("KongMQ:",t)},init:function(){this.on("next",()=>{this.pop()}).on("ack",t=>{this.acknowledged=!0,this.pop()}).on("expired",t=>{this.log("Processing expired message [".concat(t.id,"]...")),this.client.hdel(this._key("processing"),t.id,(e,i)=>{e&&this.emit("error",e),this.emit("destroyed",t),this.emit("ack",t)})}).on("timeout",t=>{t.retry+=1;var e=this.client.multi();t.retry<this.options.retry&&e.rpush(this.id,JSON.stringify(t)),e.hdel(this._key("processing"),t.id).exec(e=>{e&&this.emit("error",e),t.retry>this.options.retry?(this.log("Moving message ID [".concat(t.id,"] to dead-letter queue...")),this.emit("dead",t)):(this.log("Re-queuing message (ID [".concat(t.id,"], attempts [").concat(t.retry,"])...")),this.emit("requeued",t)),this.emit("ack",t)})}).on("error",t=>{console.error(t)}),process.on("SIGINT",()=>{this.exit()}),process.on("SIGTERM",()=>{this.exit()}),this.options.auto&&this.run()},run:function(){setTimeout(()=>{this.pop()},1e3)},push:function(t,e,i){var s=new o(Object.assign({body:t},e||{}));n.isNullOrUndefined(s.id)&&(s.id=this.random(6)),this.client.rpush(this.id,JSON.stringify(s),i)},process:function(t){if(this._expired(t))this.emit("expired",t);else{this.log("Processing message [".concat(t.id,"]..."));var e=t.timeout||this.options.timeout;e&&(this.timer=setTimeout(()=>{this.emit("timeout",t)},e)),this.client.hset(this._key("processing"),t.id,JSON.stringify(t),(e,i)=>{e&&this.emit("error",e),this.emit("process",t),this.options.limit||this.ack(t)})}},pop:function(){this.idle||(this.timer&&clearTimeout(this.timer),this.client.hlen(this._key("processing"),(t,e)=>{var i=parseInt(e)||0;this.options.limit>0&&i>=this.options.limit||this.client.lpop(this.id,(t,e)=>{t&&this.emit("error",t),e?this.process(JSON.parse(e)):this.run()})}))},ack:function(t){this.client.hdel(this._key("processing"),t.id,(e,i)=>{e&&this.emit("error",e),this.log("Message [".concat(t.id,"] successfully processed")),this.emit("ack",t)})},pause:function(){this.idle=!0},resume:function(){this.idle=!1},flush:function(){this.client.multi().del(this.id).del(this._key("processing")).exec(()=>{})},clean:function(){this.flush()},exit:function(){this.pause(),setTimeout(()=>{process.exit(0)},3e3)},random:function(t){return s.randomBytes(t).toString("hex")}},n.inherits(c,r),t.exports=c},function(t,e){t.exports=require("crypto")},function(t,e){t.exports=class{constructor(t){this.id=null,this.body=null,this.ttl=null,this.created=Date.now(),this.retry=0,this.timeout=9e3,t&&("string"==typeof t&&(t=JSON.parse(t)),Object.assign(this,t))}}}]);